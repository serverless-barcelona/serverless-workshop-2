service: serverless-barcelona-workshop-2

frameworkVersion: ">=1.2.0 <2.0.0"

custom:
  s3Bucket: ${self:service}
  accountId: ${file(./accountHelper.js):getAccountId}
  streamBucket: ${self:service}-${self:custom.accountId}

provider:
  name: aws
  runtime: nodejs12.x
  region: eu-west-1
  memorySize: 128
  timeout: 10
  iamRoleStatements: # IAM role statements so that services can be accessed in the AWS account
  - Effect: 'Allow'
    Action:
      - 'firehose:PutRecord'
    Resource:
      Fn::GetAtt: 
            - FirehoseStream
            - Arn

functions:
  api:
    handler: handler.api
    events:
      - http:
          path: openapi
          method: post
          cors: true
  pushApi:
    handler: firehoseHandler.push
    environment:
      DELIVERY_STREAM: 
        Ref: FirehoseStream
 
    events:
      - http:
          path: api
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: CognitoAuthorizer
resources:
  - ${file(./cf-resources/cognito.yml)}
  - ${file(./cf-resources/website-bucket.yml)}
  - ${file(./cf-resources/firehose.yml)}
  - ${file(./cf-resources/outputs.yml)}
  - ${file(./cf-resources/kinesis-analytics.yml)}
  - ${file(./cf-resources/glue.yml)}

